version: '3.8'

services:
  acestream:
    # This is the original x86_64 image running via QEMU emulation
    # WORKING configuration - tested and verified on Raspberry Pi 5
    image: ghcr.io/martinbjeldbak/acestream-http-proxy:latest
    platform: linux/amd64  # Force x86_64 architecture (will use QEMU)
    container_name: acestream-proxy
    ports:
      - "6878:6878"
    environment:
      - ALLOW_REMOTE_ACCESS=yes  # Change to 'no' for localhost only
      - TZ=Atlantic/Canary
    restart: unless-stopped
    volumes:
      # Persist cache/data (optional but recommended)
      - ./acestream-data:/root/.ACEStream
    # Resource limits - emulation needs more resources
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    # SHM size increased for emulation performance
    shm_size: 1G
    # Healthcheck to monitor service availability
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6878/webui/api/service?method=get_version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s  # Longer startup time for emulation

# IMPORTANT: QEMU support is automatically configured, but ensure it's installed:
# sudo apt-get install -y qemu-user-static binfmt-support
#
# STATUS: âœ… WORKING - This is the most reliable configuration
# Performance: ~30% slower than native ARM64 due to emulation
# Acestream Version: Latest (3.2.x)
# Reliability: Very stable, minimal crashes
#
# Usage after starting:
# HLS streams: http://localhost:6878/ace/manifest.m3u8?id=YOUR_STREAM_ID
# MPEG-TS: http://localhost:6878/ace/getstream?id=YOUR_STREAM_ID
#
# Check status: docker compose -f docker-compose-emulated.yml ps
# View logs: docker compose -f docker-compose-emulated.yml logs -f
# Test API: curl http://localhost:6878/webui/api/service?method=get_version
